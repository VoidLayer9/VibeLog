# VibeLog — Especificação Completa

## 1. Visão Geral

**VibeLog** é um blog estático-dinâmico chamado **mateusmoutinho**, servido por um servidor HTTP escrito em C puro (editando `app.c`). O banco de dados é baseado em arquivos no filesystem (sem SQL).

### 1.1 Identidade Visual

| Aspecto         | Definição                                                                 |
|-----------------|---------------------------------------------------------------------------|
| Tema            | Dark, minimalista, com atmosfera "demoníaca" / ocultista                  |
| Paleta primária | Background: `#0a0a0a`, Cards: `#111111`, Bordas: `#1a1a1a`               |
| Paleta de acento| Vermelho sangue: `#8b0000`, Vermelho hover: `#a00000`, Laranja rúnico: `#cc4400` |
| Texto           | Primário: `#e0e0e0`, Secundário: `#888888`, Links: `#cc4400`             |
| Tipografia      | Títulos: serif (ex: `Cinzel`, `Playfair Display`), Corpo: sans-serif (ex: `Inter`, `Source Sans Pro`) |
| Ícones          | Minimalistas, monocromáticos, sem emojis                                  |
| Referências     | Inspiração: sites como [motherfuckingwebsite.com](http://motherfuckingwebsite.com) (minimalismo) + estética de grimórios medievais |

### 1.2 Configuração do Servidor

| Parâmetro       | Valor                  |
|-----------------|------------------------|
| Porta padrão    | `8080` (configurável via flag de argv inicial (--port)`) |
| Encoding        | UTF-8 em todos os responses |
| Content-Type    | Sempre incluir `charset=utf-8` para text/html |

---

## 2. Rotas

### 2.1 `GET /` — Página Inicial

**Descrição:** Página principal do blog.

**Componentes:**

#### Navbar (componente global — reutilizado em todas as rotas HTML)

| Elemento              | Destino                                                              |
|-----------------------|----------------------------------------------------------------------|
| Logo/Nome do blog     | `/`                                                                  |
| Botão "Lua"           | `/list_articles?page=1&category=lua&limit=10`                        |
| Botão "C"             | `/list_articles?page=1&category=C&limit=10`                          |
| Botão "Vibecoding"    | `/list_articles?page=1&category=Vibecoding&limit=10`                 |
| Botão "Software Architecture" | `/list_articles?page=1&category=Software+Architecture&limit=10` |
| Campo de busca        | Ao submeter, redireciona para `/list_articles?page=1&limit=10&search={input}` |

> **Nota:** O nome padronizado da rota é `/list_articles` (plural) em todos os contextos.

#### Body

- Exibe os **5 artigos mais recentes** (ordenados por data decrescente).
- Cada card de artigo exibe:
  - Thumbnail (via `/database_file?path=<thumbnail_path>`)
  - Título (link para `/article?date=<date>&id=<article_id>`)
  - Resumo (truncado em 200 caracteres com "...")
  - Data de publicação (formato: `13 Fev 2026`)
  - Categorias como badges/tags

#### Sidebar

- **Total de views do site** (soma de todos os `total_views.json`)
- **Views por categoria** (soma das views dos artigos de cada categoria), ordenadas de forma decrescente
- Atualização: os valores da sidebar devem ser **cacheados em memória** e recalculados a cada **5 minutos** (não a cada request)

---

### 2.2 `GET /list_articles` — Listagem de Artigos

**Query parameters:**

| Parâmetro  | Tipo    | Obrigatório | Default | Descrição                                    |
|------------|---------|-------------|---------|----------------------------------------------|
| `page`     | int     | Não         | `1`     | Número da página (1-indexed)                 |
| `limit`    | int     | Não         | `10`    | Artigos por página (max: 50)                 |
| `category` | string  | Não         | —       | Filtra por categoria (case-insensitive)      |
| `search`   | string  | Não         | —       | Busca no título e no resumo (case-insensitive) |

**Comportamento:**

- Ordenação padrão: data decrescente (mais recente primeiro).
- Se `category` e `search` forem fornecidos simultaneamente, ambos os filtros se aplicam (AND).
- A busca (`search`) opera sobre os campos `title` e `summary` do `data.json`. **Não** faz busca no conteúdo HTML.

**Resposta HTML:**

- Navbar global.
- Lista de artigos com: thumbnail, título (link), resumo, data e categorias.
- **Paginação** no rodapé: botões "Anterior" / "Próxima" com os query params preservados.
- **Estado vazio**: se nenhum artigo corresponder ao filtro, exibir a mensagem "Nenhum artigo encontrado" com um link para voltar à página inicial.

---

### 2.3 `GET /article` — Artigo Completo

**Query parameters:**

| Parâmetro | Tipo   | Obrigatório | Descrição                          |
|-----------|--------|-------------|------------------------------------|
| `date`    | string | Sim         | Data no formato `DD-MM-YYYY`       |
| `id`      | string | Sim         | ID do artigo (nome da pasta)       |

**Detecção de idioma:**

1. Verificar o header `Accept-Language` do request.
2. Extrair o código de idioma primário (ex: `pt` de `pt-BR,pt;q=0.9,en;q=0.8`).
3. Verificar se existe o arquivo `content/{lang}.html` no diretório do artigo.
4. Se existir, servir essa versão. Caso contrário, servir `content/en.html` como fallback.
5. Se `en.html` também não existir, retornar **404**.

**Resposta HTML:**

- Navbar global.
- Título do artigo (do `data.json`).
- Conteúdo HTML do artigo (injetado diretamente no body).
- Categorias como badges.
- **Footer do artigo:**
  - Nome do autor (link para `/author?id={author_id}`)
  - Foto do autor (via `/database_file?path=...`)
  - Data de publicação

**Registro de métricas (ao acessar esta rota):**

- Incrementar `total_views.json` do artigo correspondente.
- Criar um arquivo de view individual no diretório `views/` (ver Seção 4.2).
- **Escrita atômica para `total_views.json`**: ler arquivo → modificar em memória → escrever em arquivo temporário → `rename()` para o path final. Isso previne corrupção por requests concorrentes.
- **Views individuais não precisam de escrita atômica** pois cada request cria um arquivo novo com nome único (sem conflito de concorrência).

---

### 2.4 `GET /database_file` — Servir Arquivos Estáticos

**Query parameters:**

| Parâmetro | Tipo   | Obrigatório | Descrição                     |
|-----------|--------|-------------|-------------------------------|
| `path`    | string | Sim         | Caminho relativo ao diretório `database/` |

**Segurança (OBRIGATÓRIO):**

1. **Sanitização de path**: rejeitar qualquer path que contenha `..`, comece com `/`, ou contenha null bytes.
2. **Jail no diretório**: após resolver o path, validar com `realpath()` que o caminho absoluto resultante está **dentro** do diretório `database/`.
3. Se a validação falhar, retornar **403 Forbidden**.
4. Se o arquivo não existir, retornar **404 Not Found**.

**Content-Type por extensão:**

| Extensão   | Content-Type          |
|------------|-----------------------|
| `.jpg/.jpeg` | `image/jpeg`        |
| `.png`     | `image/png`           |
| `.gif`     | `image/gif`           |
| `.webp`    | `image/webp`          |
| `.html`    | `text/html; charset=utf-8` |
| `.json`    | `application/json`    |
| `.css`     | `text/css`            |
| `.js`      | `application/javascript` |
| Outros     | `application/octet-stream` |

**Cache headers:**

- Imagens: `Cache-Control: public, max-age=86400` (24h)
- Outros: `Cache-Control: no-cache`

---

### 2.5 `GET /author` — Página do Autor

**Query parameters:**

| Parâmetro | Tipo   | Obrigatório | Descrição                    |
|-----------|--------|-------------|------------------------------|
| `id`      | string | Sim         | ID do autor (nome da pasta)  |

**Resposta HTML:**

- Navbar global.
- Foto do autor (tamanho grande).
- Nome do autor.
- Descrição completa do autor (do `data.json`).
- Lista dos artigos daquele autor (mais recentes primeiro), com links.

---

### 2.6 `GET /about` — Página Sobre

**Fonte do conteúdo:** arquivo estático `database/pages/about.html`.

**Resposta HTML:**

- Navbar global.
- Conteúdo do `about.html` injetado no body com o layout padrão do site.

---

## 3. Páginas de Erro

| Código | Quando                                     | Conteúdo                                      |
|--------|--------------------------------------------|-----------------------------------------------|
| 400    | Query params inválidos, malformados        | "Requisição inválida" + link para `/`         |
| 403    | Path traversal em `/database_file`         | "Acesso negado" + link para `/`               |
| 404    | Artigo/autor/arquivo não encontrado        | "Página não encontrada" + link para `/`       |
| 500    | Erro interno (falha ao ler arquivo, etc.)  | "Erro interno do servidor" + link para `/`    |

Todas as páginas de erro devem usar o layout padrão do site (com navbar) e manter a identidade visual.

---

## 4. Banco de Dados (Filesystem)

### 4.1 Estrutura de Diretórios

```
database/
├── articles/
│   └── DD-MM-YYYY/
│       └── <article_id>/
│           ├── data.json
│           ├── content/
│           │   ├── en.html
│           │   ├── pt.html
│           │   └── ... (outros idiomas)
│           └── assets/
│               ├── thumbnail.jpg
│               └── ... (outras imagens)
├── authors/
│   └── <author_id>/
│       ├── data.json
│       └── assets/
│           └── picture.jpg
├── metrics/
│   └── articles/
│       └── DD-MM-YYYY/
│           └── <article_id>/
│               ├── total_views.json
│               └── views/
│                   └── <DD-MM-YYYY>:<unix_timestamp>/
│                       └── <view_uuid>.json
└── pages/
    └── about.html
```

### 4.2 Schemas

#### `articles/<date>/<article_id>/data.json`

```json
{
    "title": "Como usar Metatables em Lua",
    "summary": "Um guia completo sobre metatables, metamethods e como eles habilitam OOP em Lua.",
    "author_id": "mateus",
    "thumbnail": "assets/thumbnail.jpg",
    "categories": ["lua", "programming"]
}
```

| Campo        | Tipo     | Descrição                                                       |
|--------------|----------|-----------------------------------------------------------------|
| `title`      | string   | Título do artigo                                                |
| `summary`    | string   | Resumo do artigo (max recomendado: 300 caracteres)              |
| `author_id`  | string   | ID do autor (corresponde ao nome da pasta em `authors/`)        |
| `thumbnail`  | string   | Caminho relativo ao diretório do artigo para a thumbnail        |
| `categories` | string[] | Lista de categorias (armazenadas em lowercase para comparação)  |

> **Nota:** O campo foi renomeado de `author` para `author_id` para deixar explícito que é uma referência ao diretório do autor, não um nome de exibição.

> **Nota:** A `date` do artigo é derivada do nome do diretório pai (`DD-MM-YYYY`), não armazenada no JSON. O `id` do artigo é o nome da própria pasta.

#### `authors/<author_id>/data.json`

```json
{
    "name": "Mateus Moutinho",
    "description": "CTO da OUI Tec. Desenvolvedor C, criador de frameworks open source, entusiasta de automação.",
    "picture": "assets/picture.jpg"
}
```

| Campo        | Tipo   | Descrição                                           |
|--------------|--------|-----------------------------------------------------|
| `name`       | string | Nome de exibição do autor                           |
| `description`| string | Descrição/bio completa do autor                     |
| `picture`    | string | Caminho relativo ao diretório do autor para a foto  |

#### `metrics/articles/<date>/<article_id>/total_views.json`

```json
{
    "views": 1542
}
```

| Campo  | Tipo   | Descrição                |
|--------|--------|--------------------------|
| `views`| number | Contador total de views  |

> **Nota:** O tipo é `number` (inteiro), **não** string.

#### Views Individuais — `metrics/articles/<date>/<article_id>/views/<DD-MM-YYYY>:<unix_timestamp>/<view_uuid>.json`

**Estrutura de diretórios de views:**

```
views/
├── 13-02-2026:1739462400/
│   ├── a1b2c3d4.json
│   ├── e5f6g7h8.json
│   └── i9j0k1l2.json
├── 14-02-2026:1739548800/
│   └── m3n4o5p6.json
└── ...
```

**Formato do nome do diretório de dia:** `<DD-MM-YYYY>:<unix_timestamp>`
- `DD-MM-YYYY` — data legível do dia (mesmo formato usado nos artigos)
- `unix_timestamp` — timestamp Unix (em segundos) correspondente à meia-noite UTC daquele dia
- Exemplo: `13-02-2026:1739404800`

**Formato do nome do arquivo de view:** `<view_uuid>.json`
- UUID v4 ou identificador único gerado no momento do request (ex: combinação de timestamp + random)
- Garante unicidade sem necessidade de locks ou leitura prévia

**Conteúdo de cada arquivo de view:**

```json
{
    "date": "2026-02-13T17:00:00Z",
    "country": "BR",
    "duration": 0,
    "device": "mobile"
}
```

| Campo     | Tipo   | Descrição                                            |
|-----------|--------|------------------------------------------------------|
| `date`    | string | Timestamp ISO 8601 do acesso                         |
| `country` | string | Código do país (ISO 3166-1 alpha-2) ou `"unknown"`   |
| `duration`| number | Duração em segundos (0 = não rastreado)              |
| `device`  | string | `"mobile"` ou `"desktop"` (inferido do User-Agent)   |

**Vantagens desta abordagem:**

1. **Zero contenção de escrita**: cada request cria um arquivo independente, sem necessidade de ler/modificar/escrever um array compartilhado.
2. **Sem locks**: não há risco de corrupção por requests concorrentes nas views detalhadas.
3. **Consulta por dia nativa**: basta listar os arquivos dentro do diretório do dia desejado.
4. **Remoção granular**: para limpar dados antigos, basta deletar diretórios de dias inteiros (`rm -rf <dia>`).
5. **Escalabilidade**: o filesystem distribui a carga em vez de concentrar tudo em um único arquivo crescente.

**Rotação de dados:**

- Diretórios de views com mais de **90 dias** podem ser removidos por um processo de limpeza periódico (cron job externo ou rotina interna do servidor).
- Alternativamente, diretórios antigos podem ser compactados (`tar.gz`) e movidos para um diretório de arquivo morto (`views_archive/`).
- O `total_views.json` permanece como fonte verdade para contagem total (não é afetado pela rotação).

---

## 5. Regras de Implementação

### 5.1 Cache em Memória

- Os dados da **sidebar** (total de views e views por categoria) devem ser cacheados em memória.
- O cache é recalculado a cada **5 minutos** (não a cada request).
- Na inicialização do servidor, calcular o cache imediatamente.

### 5.2 Escrita Atômica de Métricas

A escrita atômica é necessária **apenas para `total_views.json`**, que é o único arquivo de métricas sujeito a read-modify-write concorrente:

```
1. Ler o arquivo existente
2. Modificar os dados em memória (incrementar counter)
3. Escrever em um arquivo temporário (mesmo diretório, sufixo .tmp)
4. rename() do temporário para o path final
```

**Views individuais** (`views/<dia>/<uuid>.json`) são criadas como arquivos novos com nomes únicos, portanto **não precisam de escrita atômica** — basta um `open(O_CREAT | O_EXCL)` + `write()` + `close()`.

### 5.3 Criação Automática de Diretórios de Métricas

Se o diretório de métricas para um artigo não existir no momento do acesso, o servidor deve:

1. Criar o diretório recursivamente (`mkdir -p` equivalente), incluindo o subdiretório `views/`.
2. Inicializar `total_views.json` com `{"views": 0}`.

Ao registrar uma view, se o subdiretório do dia (`views/<DD-MM-YYYY>:<unix>`) não existir, criá-lo automaticamente.

### 5.4 Registro de View — Fluxo Completo

Ao acessar `GET /article`:

```
1. Determinar o diretório de métricas: metrics/articles/<date>/<article_id>/
2. Se não existir, criar e inicializar (Seção 5.3)
3. Incrementar total_views.json (escrita atômica)
4. Determinar o diretório do dia: views/<DD-MM-YYYY>:<unix_meia_noite>/
5. Se não existir, criar com mkdir
6. Gerar UUID para o arquivo
7. Criar <uuid>.json com os dados da view:
   - date: timestamp ISO 8601 atual
   - country: header CF-IPCountry ou "unknown"
   - device: inferido do User-Agent (mobile/desktop)
   - duration: 0
```

### 5.5 CORS

Não habilitado por padrão (o blog é servido do mesmo domínio). Se necessário no futuro, adicionar como configuração.

### 5.6 Encoding

- Todo texto servido é **UTF-8**.
- Headers HTML devem incluir `<meta charset="utf-8">`.
- Responses HTTP de tipo texto devem incluir `charset=utf-8` no `Content-Type`.