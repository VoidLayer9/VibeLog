# VibeLog — Complete Specification

## 1. Overview

**VibeLog** is a static-dynamic blog called **vibelog**, served by an HTTP server written in pure C (editing `app.c`). The database is file-based on the filesystem (no SQL).

### 1.1 Visual Identity

| Aspect          | Definition                                                                 |
|-----------------|---------------------------------------------------------------------------|
| Theme           | Dark minimalist, industrial — cold, precise "dark corporate spirit"       |
| Primary palette | Background: `#09090b`, Cards: `#111113`, Borders: `#1c1c1f`, Surface: `#16161a` |
| Accent palette  | Corporate teal: `#0d9488`, Hover teal: `#14b8a6`, Steel highlight: `#3b82f6` |
| Text            | Primary: `#d4d4d8`, Secondary: `#71717a`, Links: `#0d9488`, Muted: `#52525b` |
| Typography      | Titles: sans-serif industrial (e.g. `IBM Plex Sans`, `Space Grotesk`), Body: clean sans (e.g. `Inter`, `IBM Plex Sans`), Monospace accents: `JetBrains Mono` |
| Icons           | Minimalist, monochromatic, geometric strokes — no emojis, no ornament     |
| Borders/Effects | Hairline borders (`1px solid #1c1c1f`), no rounded corners (sharp/angular), subtle `box-shadow: 0 1px 2px rgba(0,0,0,0.5)` on cards |
| References      | Inspiration: Dieter Rams (functional minimalism) + Bloomberg Terminal aesthetics + brutalist corporate dashboards |

### 1.2 Server Configuration

| Parameter       | Value                  |
|-----------------|------------------------|
| Default port    | `8080` (configurable via initial argv flag (--port)) |
| Encoding        | UTF-8 in all responses |
| Content-Type    | Always include `charset=utf-8` for text/html |

---

## 2. Routes

### 2.1 `GET /` — Home Page

**Description:** Main blog page.

**Components:**

#### Navbar (global component — reused in all HTML routes)

| Element                       | Destination                                                          |
|-------------------------------|----------------------------------------------------------------------|
| Logo/Blog name                | `/`                                                                  |
| Category buttons (dynamic)    | Generated from `database/categorys.json` — only entries with `"navbar": true` produce a button linking to `/list_articles?page=1&category={name}&limit=10` |
| "Categories" dropdown         | A dropdown menu listing **all** categories from `database/categorys.json` (regardless of `navbar` flag). Each item links to `/list_articles?page=1&category={name}&limit=10`. The dropdown label is "Categories" and each item displays the category `name`. The category `description` is shown as a tooltip (`title` attribute) on hover. |
| Search field                  | On submit, redirects to `/list_articles?page=1&limit=10&search={input}` |

**Categories dropdown behavior:**

- The dropdown toggle button displays the text **"Categories"**.
- Clicking the toggle opens/closes a dropdown panel listing all categories.
- Each category entry in the dropdown is a link to `/list_articles?page=1&category={name}&limit=10`.
- The dropdown should close when clicking outside of it.
- The dropdown should follow the site's dark industrial/corporate visual identity (dark background, hairline borders, teal accent on hover).

**Category source file:** `database/categorys.json`

```json
[
    {
        "name": "Lua",
        "navbar": true,
        "description": "Articles about the Lua language and its ecosystem"
    },
    {
        "name": "C",
        "navbar": true,
        "description": "Low-level development and architecture in C"
    },
    {
        "name": "Vibecoding",
        "navbar": true,
        "description": "Code philosophy, minimalism and aesthetics"
    }
]
```

| Field         | Type    | Description                                              |
|---------------|---------|----------------------------------------------------------|
| `name`        | string  | Category name displayed on the button/dropdown item and used as the `category` query param |
| `navbar`      | boolean | If `true`, this category appears as a **direct button** in the navbar. All categories (regardless of this flag) appear in the "Categories" dropdown. |
| `description` | string  | Category description (shown as tooltip on dropdown items and navbar buttons) |

> **Note:** To add or remove categories from the **quick-access navbar buttons**, edit `categorys.json` and set the `navbar` field to `true` or `false`. The "Categories" dropdown always includes every category. No code changes required.

> **Note:** The standardized route name is `/list_articles` (plural) in all contexts.

#### Body

- Displays the **5 most recent articles** (ordered by descending date).
- Each article card displays:
  - Thumbnail (via `/database_file?path=<thumbnail_path>`)
  - Title (link to `/article?date=<date>&id=<article_id>`)
  - Summary (truncated at 200 characters with "...")
  - Publication date (format: `13 Feb 2026`)
  - Categories as badges/tags

#### Sidebar

- **Total site views** (sum of all `total_views.json`)
- **Views per category** (sum of article views for each category), ordered in descending order
- Update: sidebar values should be **cached in memory** and recalculated every **5 minutes** (not on every request)

---

### 2.2 `GET /list_articles` — Article Listing

**Query parameters:**

| Parameter  | Type    | Required | Default | Description                                  |
|------------|---------|----------|---------|----------------------------------------------|
| `page`     | int     | No       | `1`     | Page number (1-indexed)                      |
| `limit`    | int     | No       | `10`    | Articles per page (max: 50)                  |
| `category` | string  | No       | —       | Filter by category (case-insensitive)        |
| `search`   | string  | No       | —       | Search in title and summary (case-insensitive) |

**Behavior:**

- Default ordering: descending date (most recent first).
- If `category` and `search` are provided simultaneously, both filters apply (AND).
- The search (`search`) operates on the `title` and `summary` fields of `data.json`. Does **not** search in HTML content.

**HTML Response:**

- Global navbar.
- List of articles with: thumbnail, title (link), summary, date and categories.
- **Pagination** in footer: "Previous" / "Next" buttons with preserved query params.
- **Empty state**: if no articles match the filter, display the message "No articles found" with a link back to the home page.

---

### 2.3 `GET /article` — Full Article

**Query parameters:**

| Parameter | Type   | Required | Description                        |
|-----------|--------|----------|------------------------------------|
| `date`    | string | Yes      | Date in format `DD-MM-YYYY`        |
| `id`      | string | Yes      | Article ID (folder name)           |

**Language detection:**

1. Check the `Accept-Language` header of the request.
2. Extract the primary language code (e.g. `pt` from `pt-BR,pt;q=0.9,en;q=0.8`).
3. Check if the file `content/{lang}.html` exists in the article directory.
4. If it exists, serve that version. Otherwise, serve `content/en.html` as fallback.
5. If `en.html` also doesn't exist, return **404**.

**HTML Response:**

- Global navbar.
- Article title (from `data.json`).
- Article HTML content (injected directly into body).
- Categories as badges.
- **Article footer:**
  - Author name (link to `/author?id={author_id}`)
  - Author photo (via `/database_file?path=...`)
  - Publication date

**Metrics recording (when accessing this route):**

- Increment the corresponding article's `total_views.json`.
- Create an individual view file in the `views/` directory (see Section 4.2).
- **Atomic write for `total_views.json`**: read file → modify in memory → write to temporary file → `rename()` to final path. This prevents corruption from concurrent requests.
- **Individual views don't need atomic writes** since each request creates a new file with a unique name (no concurrency conflict).

---

### 2.4 `GET /database_file` — Serve Static Files

**Query parameters:**

| Parameter | Type   | Required | Description                       |
|-----------|--------|----------|-----------------------------------|
| `path`    | string | Yes      | Path relative to `database/` directory |

**Security (MANDATORY):**

1. **Path sanitization**: reject any path containing `..`, starting with `/`, or containing null bytes.
2. **Directory jail**: after resolving the path, validate with `realpath()` that the resulting absolute path is **inside** the `database/` directory.
3. If validation fails, return **403 Forbidden**.
4. If the file doesn't exist, return **404 Not Found**.

**Content-Type by extension:**

| Extension    | Content-Type          |
|--------------|-----------------------|
| `.jpg/.jpeg` | `image/jpeg`          |
| `.png`       | `image/png`           |
| `.gif`       | `image/gif`           |
| `.webp`      | `image/webp`          |
| `.html`      | `text/html; charset=utf-8` |
| `.json`      | `application/json`    |
| `.css`       | `text/css`            |
| `.js`        | `application/javascript` |
| Others       | `application/octet-stream` |

**Cache headers:**

- Images: `Cache-Control: public, max-age=86400` (24h)
- Others: `Cache-Control: no-cache`

---

### 2.5 `GET /author` — Author Page

**Query parameters:**

| Parameter | Type   | Required | Description                  |
|-----------|--------|----------|------------------------------|
| `id`      | string | Yes      | Author ID (folder name)      |

**HTML Response:**

- Global navbar.
- Author photo (large size).
- Author name.
- Full author description (from `data.json`).
- List of that author's articles (most recent first), with links.

---

### 2.6 `GET /about` — About Page

**Content source:** static file `database/pages/about.html`.

**HTML Response:**

- Global navbar.
- Content from `about.html` injected into body with the site's standard layout.

---

## 3. Error Pages

| Code | When                                       | Content                                      |
|------|--------------------------------------------|----------------------------------------------|
| 400  | Invalid, malformed query params            | "Invalid request" + link to `/`              |
| 403  | Path traversal in `/database_file`         | "Access denied" + link to `/`                |
| 404  | Article/author/file not found              | "Page not found" + link to `/`               |
| 500  | Internal error (file read failure, etc.)   | "Internal server error" + link to `/`        |

All error pages should use the site's standard layout (with navbar) and maintain the visual identity.

---

## 4. Database (Filesystem)

### 4.1 Directory Structure

```
database/
├── categorys.json
├── articles/
│   └── DD-MM-YYYY/
│       └── <article_id>/
│           ├── data.json
│           ├── content/
│           │   ├── en.html
│           │   ├── pt.html
│           │   └── ... (other languages)
│           └── assets/
│               ├── thumbnail.jpg
│               └── ... (other images)
├── authors/
│   └── <author_id>/
│       ├── data.json
│       └── assets/
│           └── picture.jpg
├── metrics/
│   └── articles/
│       └── DD-MM-YYYY/
│           └── <article_id>/
│               ├── total_views.json
│               └── views/
│                   └── <DD-MM-YYYY>:<unix_timestamp>/
│                       └── <view_uuid>.json
└── pages/
    └── about.html
```

### 4.2 Schemas

#### `articles/<date>/<article_id>/data.json`

```json
{
    "title": "How to use Metatables in Lua",
    "summary": "A complete guide on metatables, metamethods and how they enable OOP in Lua.",
    "author_id": "mateus",
    "thumbnail": "assets/thumbnail.jpg",
    "categories": ["lua", "programming"]
}
```

| Field        | Type     | Description                                                     |
|--------------|----------|-----------------------------------------------------------------|
| `title`      | string   | Article title                                                   |
| `summary`    | string   | Article summary (recommended max: 300 characters)               |
| `author_id`  | string   | Author ID (corresponds to folder name in `authors/`)            |
| `thumbnail`  | string   | Relative path from article directory to thumbnail               |
| `categories` | string[] | List of categories (stored in lowercase for comparison)         |

> **Note:** The field was renamed from `author` to `author_id` to make it explicit that it's a reference to the author directory, not a display name.

> **Note:** The article's `date` is derived from the parent directory name (`DD-MM-YYYY`), not stored in JSON. The article's `id` is the folder name itself.

#### `authors/<author_id>/data.json`

```json
{
    "name": "Mateus Moutinho",
    "description": "CTO at OUI Tec. C developer, creator of open source frameworks, automation enthusiast.",
    "picture": "assets/picture.jpg"
}
```

| Field        | Type   | Description                                         |
|--------------|--------|-----------------------------------------------------|
| `name`       | string | Author's display name                               |
| `description`| string | Author's full description/bio                       |
| `picture`    | string | Relative path from author directory to photo        |

#### `metrics/articles/<date>/<article_id>/total_views.json`

```json
{
    "views": 1542
}
```

| Field  | Type   | Description              |
|--------|--------|--------------------------|
| `views`| number | Total view counter       |

> **Note:** The type is `number` (integer), **not** string.

#### Individual Views — `metrics/articles/<date>/<article_id>/views/<DD-MM-YYYY>:<unix_timestamp>/<view_uuid>.json`

**Views directory structure:**

```
views/
├── 13-02-2026:1739462400/
│   ├── a1b2c3d4.json
│   ├── e5f6g7h8.json
│   └── i9j0k1l2.json
├── 14-02-2026:1739548800/
│   └── m3n4o5p6.json
└── ...
```

**Day directory name format:** `<DD-MM-YYYY>:<unix_timestamp>`
- `DD-MM-YYYY` — human-readable date of the day (same format used in articles)
- `unix_timestamp` — Unix timestamp (in seconds) corresponding to midnight UTC of that day
- Example: `13-02-2026:1739404800`

**View file name format:** `<view_uuid>.json`
- UUID v4 or unique identifier generated at request time (e.g. combination of timestamp + random)
- Guarantees uniqueness without need for locks or prior reading

**Content of each view file:**

```json
{
    "date": "2026-02-13T17:00:00Z",
    "country": "BR",
    "duration": 0,
    "device": "mobile"
}
```

| Field     | Type   | Description                                          |
|-----------|--------|------------------------------------------------------|
| `date`    | string | ISO 8601 timestamp of access                         |
| `country` | string | Country code (ISO 3166-1 alpha-2) or `"unknown"`     |
| `duration`| number | Duration in seconds (0 = not tracked)                |
| `device`  | string | `"mobile"` or `"desktop"` (inferred from User-Agent) |

**Advantages of this approach:**

1. **Zero write contention**: each request creates an independent file, no need to read/modify/write a shared array.
2. **No locks**: no risk of corruption from concurrent requests on detailed views.
3. **Native day-based querying**: just list files within the desired day's directory.
4. **Granular removal**: to clean old data, just delete entire day directories (`rm -rf <day>`).
5. **Scalability**: the filesystem distributes the load instead of concentrating everything in a single growing file.

**Data rotation:**

- View directories older than **90 days** can be removed by a periodic cleanup process (external cron job or internal server routine).
- Alternatively, old directories can be compressed (`tar.gz`) and moved to an archive directory (`views_archive/`).
- The `total_views.json` remains as the source of truth for total count (not affected by rotation).

---

## 5. Implementation Rules

### 5.1 Memory Cache

- **Sidebar** data (total views and views per category) should be cached in memory.
- Cache is recalculated every **5 minutes** (not on every request).
- On server startup, calculate the cache immediately.

### 5.2 Atomic Metrics Writing

Atomic writing is necessary **only for `total_views.json`**, which is the only metrics file subject to concurrent read-modify-write:

```
1. Read existing file
2. Modify data in memory (increment counter)
3. Write to temporary file (same directory, .tmp suffix)
4. rename() from temporary to final path
```

**Individual views** (`views/<day>/<uuid>.json`) are created as new files with unique names, therefore **don't need atomic writes** — just an `open(O_CREAT | O_EXCL)` + `write()` + `close()`.

### 5.3 Automatic Creation of Metrics Directories

If the metrics directory for an article doesn't exist at access time, the server should:

1. Create the directory recursively (`mkdir -p` equivalent), including the `views/` subdirectory.
2. Initialize `total_views.json` with `{"views": 0}`.

When recording a view, if the day subdirectory (`views/<DD-MM-YYYY>:<unix>`) doesn't exist, create it automatically.

### 5.4 View Recording — Complete Flow

When accessing `GET /article`:

```
1. Determine metrics directory: metrics/articles/<date>/<article_id>/
2. If it doesn't exist, create and initialize (Section 5.3)
3. Increment total_views.json (atomic write)
4. Determine day directory: views/<DD-MM-YYYY>:<unix_midnight>/
5. If it doesn't exist, create with mkdir
6. Generate UUID for the file
7. Create <uuid>.json with view data:
   - date: current ISO 8601 timestamp
   - country: CF-IPCountry header or "unknown"
   - device: inferred from User-Agent (mobile/desktop)
   - duration: 0
```

### 5.5 CORS

Not enabled by default (blog is served from the same domain). If needed in the future, add as configuration.

### 5.6 Encoding

- All served text is **UTF-8**.
- HTML headers should include `<meta charset="utf-8">`.
- HTTP responses of text type should include `charset=utf-8` in `Content-Type`.